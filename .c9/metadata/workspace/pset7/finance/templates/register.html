{"filter":false,"title":"register.html","tooltip":"/pset7/finance/templates/register.html","ace":{"folds":[],"scrolltop":207,"scrollleft":0,"selection":{"start":{"row":16,"column":62},"end":{"row":16,"column":62},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":207,"mode":"ace/mode/html"}},"hash":"e7a253808203a57de0f13e07ae93a12da00f4e34","undoManager":{"mark":100,"position":100,"stack":[[{"start":{"row":16,"column":59},"end":{"row":16,"column":60},"action":"insert","lines":["i"],"id":12}],[{"start":{"row":16,"column":60},"end":{"row":16,"column":61},"action":"insert","lines":["o"],"id":13}],[{"start":{"row":16,"column":61},"end":{"row":16,"column":62},"action":"insert","lines":["n"],"id":14}],[{"start":{"row":0,"column":0},"end":{"row":23,"column":14},"action":"remove","lines":["{% extends \"layout.html\" %}","","{% block title %}","    Register","{% endblock %}","","{% block main %}","    <form action=\"{{ url_for('register') }}\" method=\"post\">","        <fieldset>","            <div class=\"form-group\">","                <input autocomplete=\"off\" autofocus class=\"form-control\" name=\"username\" placeholder=\"Username\" type=\"text\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"password\" placeholder=\"Password\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"confirmation\" placeholder=\"Confirm Password\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <button class=\"btn btn-default\" type=\"submit\">Register</button>","            </div>","        </fieldset>","    </form>","{% endblock %}"],"id":15},{"start":{"row":0,"column":0},"end":{"row":59,"column":14},"action":"insert","lines":["<html class=\"gr__finance_cs50_net\" lang=\"en\"><head>","","        <!-- Required meta tags -->","        <meta charset=\"utf-8\">","        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">","","        <!-- documentation at http://getbootstrap.com/docs/4.0/, alternative themes at https://bootswatch.com/4-alpha/ -->","        <link href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css\" rel=\"stylesheet\">","","        <link href=\"/static/styles.css\" rel=\"stylesheet\">","","        <script src=\"https://code.jquery.com/jquery-3.1.1.min.js\"></script>","        <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js\"></script>","        <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js\"></script>","","        <title>C$50 Finance: ","    Register","</title>","","    </head>","","    <body data-gr-c-s-loaded=\"true\">","","        <nav class=\"navbar navbar-expand-md navbar-light bg-light border\">","            <a class=\"navbar-brand\" href=\"/\"><span class=\"blue\">C</span><span class=\"red\">$</span><span class=\"yellow\">5</span><span class=\"green\">0</span> <span class=\"red\">Finance</span></a>","            <button aria-controls=\"navbar\" aria-expanded=\"false\" aria-label=\"Toggle navigation\" class=\"navbar-toggler\" data-target=\"#navbar\" data-toggle=\"collapse\" type=\"button\">","                <span class=\"navbar-toggler-icon\"></span>","            </button>","            <div class=\"collapse navbar-collapse\" id=\"navbar\">","                ","                    <ul class=\"navbar-nav ml-auto mt-2\">","                        <li class=\"nav-item\"><a class=\"nav-link\" href=\"/register\">Register</a></li>","                        <li class=\"nav-item\"><a class=\"nav-link\" href=\"/login\">Log In</a></li>","                    </ul>","                ","            </div>","        </nav>","","        ","","        <main class=\"container p-5\">","            ","    <form action=\"/register\" method=\"post\">","        <div class=\"form-group\">","            <input autocomplete=\"off\" autofocus=\"\" class=\"form-control\" name=\"username\" placeholder=\"Username\" type=\"text\">","        </div>","        <div class=\"form-group\">","            <input class=\"form-control\" name=\"password\" placeholder=\"Password\" type=\"password\">","        </div>","        <div class=\"form-group\">","            <input class=\"form-control\" name=\"confirmation\" placeholder=\"Password (again)\" type=\"password\">","        </div>","        <button class=\"btn btn-primary\" type=\"submit\">Register</button>","    </form>","","        </main>","        ","    ","","</body></html>"]}],[{"start":{"row":0,"column":0},"end":{"row":1,"column":0},"action":"insert","lines":["",""],"id":16}],[{"start":{"row":16,"column":28},"end":{"row":16,"column":29},"action":"remove","lines":[" "],"id":18},{"start":{"row":30,"column":0},"end":{"row":30,"column":16},"action":"remove","lines":["                "]},{"start":{"row":35,"column":0},"end":{"row":35,"column":16},"action":"remove","lines":["                "]},{"start":{"row":39,"column":0},"end":{"row":39,"column":8},"action":"remove","lines":["        "]},{"start":{"row":42,"column":0},"end":{"row":42,"column":12},"action":"remove","lines":["            "]},{"start":{"row":57,"column":0},"end":{"row":57,"column":8},"action":"remove","lines":["        "]},{"start":{"row":58,"column":0},"end":{"row":58,"column":4},"action":"remove","lines":["    "]}],[{"start":{"row":0,"column":0},"end":{"row":60,"column":14},"action":"remove","lines":["","<html class=\"gr__finance_cs50_net\" lang=\"en\"><head>","","        <!-- Required meta tags -->","        <meta charset=\"utf-8\">","        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">","","        <!-- documentation at http://getbootstrap.com/docs/4.0/, alternative themes at https://bootswatch.com/4-alpha/ -->","        <link href=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css\" rel=\"stylesheet\">","","        <link href=\"/static/styles.css\" rel=\"stylesheet\">","","        <script src=\"https://code.jquery.com/jquery-3.1.1.min.js\"></script>","        <script src=\"https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js\"></script>","        <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js\"></script>","","        <title>C$50 Finance:","    Register","</title>","","    </head>","","    <body data-gr-c-s-loaded=\"true\">","","        <nav class=\"navbar navbar-expand-md navbar-light bg-light border\">","            <a class=\"navbar-brand\" href=\"/\"><span class=\"blue\">C</span><span class=\"red\">$</span><span class=\"yellow\">5</span><span class=\"green\">0</span> <span class=\"red\">Finance</span></a>","            <button aria-controls=\"navbar\" aria-expanded=\"false\" aria-label=\"Toggle navigation\" class=\"navbar-toggler\" data-target=\"#navbar\" data-toggle=\"collapse\" type=\"button\">","                <span class=\"navbar-toggler-icon\"></span>","            </button>","            <div class=\"collapse navbar-collapse\" id=\"navbar\">","","                    <ul class=\"navbar-nav ml-auto mt-2\">","                        <li class=\"nav-item\"><a class=\"nav-link\" href=\"/register\">Register</a></li>","                        <li class=\"nav-item\"><a class=\"nav-link\" href=\"/login\">Log In</a></li>","                    </ul>","","            </div>","        </nav>","","","","        <main class=\"container p-5\">","","    <form action=\"/register\" method=\"post\">","        <div class=\"form-group\">","            <input autocomplete=\"off\" autofocus=\"\" class=\"form-control\" name=\"username\" placeholder=\"Username\" type=\"text\">","        </div>","        <div class=\"form-group\">","            <input class=\"form-control\" name=\"password\" placeholder=\"Password\" type=\"password\">","        </div>","        <div class=\"form-group\">","            <input class=\"form-control\" name=\"confirmation\" placeholder=\"Password (again)\" type=\"password\">","        </div>","        <button class=\"btn btn-primary\" type=\"submit\">Register</button>","    </form>","","        </main>","","","","</body></html>"],"id":19},{"start":{"row":0,"column":0},"end":{"row":22,"column":7},"action":"insert","lines":["{% extends \"layout.html\" %}","","{% block title %}","    Register","{% endblock %}","","{% block main %}","    <form action=\"{{ url_for('register') }}\" method=\"post\">","        <fieldset>","            <div class=\"form-group\">","                <input autocomplete=\"off\" autofocus class=\"form-control\" name=\"username\" placeholder=\"Username\" type=\"text\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"password\" placeholder=\"Password\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"passwordagain\" placeholder=\"Password (again)\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <button class=\"btn btn-default\" type=\"submit\">Register</button>","            </div>","        </fieldset>","</form>"]}],[{"start":{"row":16,"column":62},"end":{"row":16,"column":63},"action":"remove","lines":["n"],"id":20}],[{"start":{"row":16,"column":61},"end":{"row":16,"column":62},"action":"remove","lines":["i"],"id":21}],[{"start":{"row":16,"column":60},"end":{"row":16,"column":61},"action":"remove","lines":["a"],"id":22}],[{"start":{"row":16,"column":59},"end":{"row":16,"column":60},"action":"remove","lines":["g"],"id":23}],[{"start":{"row":16,"column":58},"end":{"row":16,"column":59},"action":"remove","lines":["a"],"id":24}],[{"start":{"row":16,"column":57},"end":{"row":16,"column":58},"action":"remove","lines":["d"],"id":25}],[{"start":{"row":16,"column":56},"end":{"row":16,"column":57},"action":"remove","lines":["r"],"id":26}],[{"start":{"row":16,"column":55},"end":{"row":16,"column":56},"action":"remove","lines":["o"],"id":27}],[{"start":{"row":16,"column":54},"end":{"row":16,"column":55},"action":"remove","lines":["w"],"id":28}],[{"start":{"row":16,"column":53},"end":{"row":16,"column":54},"action":"remove","lines":["s"],"id":29}],[{"start":{"row":16,"column":52},"end":{"row":16,"column":53},"action":"remove","lines":["s"],"id":30}],[{"start":{"row":16,"column":51},"end":{"row":16,"column":52},"action":"remove","lines":["a"],"id":31}],[{"start":{"row":16,"column":50},"end":{"row":16,"column":51},"action":"remove","lines":["p"],"id":32}],[{"start":{"row":16,"column":50},"end":{"row":16,"column":51},"action":"insert","lines":["c"],"id":33}],[{"start":{"row":16,"column":51},"end":{"row":16,"column":52},"action":"insert","lines":["o"],"id":34}],[{"start":{"row":16,"column":52},"end":{"row":16,"column":53},"action":"insert","lines":["n"],"id":35}],[{"start":{"row":16,"column":53},"end":{"row":16,"column":54},"action":"insert","lines":["f"],"id":36}],[{"start":{"row":16,"column":54},"end":{"row":16,"column":55},"action":"insert","lines":["i"],"id":37}],[{"start":{"row":16,"column":55},"end":{"row":16,"column":56},"action":"insert","lines":["r"],"id":38}],[{"start":{"row":16,"column":56},"end":{"row":16,"column":57},"action":"insert","lines":["m"],"id":39}],[{"start":{"row":16,"column":57},"end":{"row":16,"column":58},"action":"insert","lines":["a"],"id":40}],[{"start":{"row":16,"column":58},"end":{"row":16,"column":59},"action":"insert","lines":["t"],"id":41}],[{"start":{"row":16,"column":59},"end":{"row":16,"column":60},"action":"insert","lines":["i"],"id":42}],[{"start":{"row":16,"column":60},"end":{"row":16,"column":61},"action":"insert","lines":["o"],"id":43}],[{"start":{"row":16,"column":61},"end":{"row":16,"column":62},"action":"insert","lines":["n"],"id":44}],[{"start":{"row":10,"column":121},"end":{"row":10,"column":122},"action":"remove","lines":["t"],"id":45}],[{"start":{"row":10,"column":120},"end":{"row":10,"column":121},"action":"remove","lines":["x"],"id":46}],[{"start":{"row":10,"column":119},"end":{"row":10,"column":120},"action":"remove","lines":["e"],"id":47}],[{"start":{"row":10,"column":118},"end":{"row":10,"column":119},"action":"remove","lines":["t"],"id":48}],[{"start":{"row":10,"column":118},"end":{"row":10,"column":119},"action":"insert","lines":["u"],"id":49}],[{"start":{"row":10,"column":119},"end":{"row":10,"column":120},"action":"insert","lines":["s"],"id":50}],[{"start":{"row":10,"column":120},"end":{"row":10,"column":121},"action":"insert","lines":["e"],"id":51}],[{"start":{"row":10,"column":121},"end":{"row":10,"column":122},"action":"insert","lines":["r"],"id":52}],[{"start":{"row":10,"column":122},"end":{"row":10,"column":123},"action":"insert","lines":["n"],"id":53}],[{"start":{"row":10,"column":123},"end":{"row":10,"column":124},"action":"insert","lines":["a"],"id":54}],[{"start":{"row":10,"column":124},"end":{"row":10,"column":125},"action":"insert","lines":["m"],"id":55}],[{"start":{"row":10,"column":125},"end":{"row":10,"column":126},"action":"insert","lines":["e"],"id":56}],[{"start":{"row":10,"column":125},"end":{"row":10,"column":126},"action":"remove","lines":["e"],"id":57}],[{"start":{"row":10,"column":124},"end":{"row":10,"column":125},"action":"remove","lines":["m"],"id":58}],[{"start":{"row":10,"column":123},"end":{"row":10,"column":124},"action":"remove","lines":["a"],"id":59}],[{"start":{"row":10,"column":122},"end":{"row":10,"column":123},"action":"remove","lines":["n"],"id":60}],[{"start":{"row":10,"column":121},"end":{"row":10,"column":122},"action":"remove","lines":["r"],"id":61}],[{"start":{"row":10,"column":120},"end":{"row":10,"column":121},"action":"remove","lines":["e"],"id":62}],[{"start":{"row":10,"column":119},"end":{"row":10,"column":120},"action":"remove","lines":["s"],"id":63}],[{"start":{"row":10,"column":118},"end":{"row":10,"column":119},"action":"remove","lines":["u"],"id":64}],[{"start":{"row":10,"column":118},"end":{"row":10,"column":119},"action":"insert","lines":["i"],"id":65}],[{"start":{"row":10,"column":119},"end":{"row":10,"column":120},"action":"insert","lines":["n"],"id":66}],[{"start":{"row":10,"column":120},"end":{"row":10,"column":121},"action":"insert","lines":["p"],"id":67}],[{"start":{"row":10,"column":121},"end":{"row":10,"column":122},"action":"insert","lines":["u"],"id":68}],[{"start":{"row":10,"column":122},"end":{"row":10,"column":123},"action":"insert","lines":["t"],"id":69}],[{"start":{"row":10,"column":102},"end":{"row":10,"column":103},"action":"remove","lines":["U"],"id":70}],[{"start":{"row":10,"column":102},"end":{"row":10,"column":103},"action":"insert","lines":["u"],"id":71}],[{"start":{"row":10,"column":122},"end":{"row":10,"column":123},"action":"remove","lines":["t"],"id":72}],[{"start":{"row":10,"column":121},"end":{"row":10,"column":122},"action":"remove","lines":["u"],"id":73}],[{"start":{"row":10,"column":120},"end":{"row":10,"column":121},"action":"remove","lines":["p"],"id":74}],[{"start":{"row":10,"column":119},"end":{"row":10,"column":120},"action":"remove","lines":["n"],"id":75}],[{"start":{"row":10,"column":118},"end":{"row":10,"column":119},"action":"remove","lines":["i"],"id":76}],[{"start":{"row":10,"column":118},"end":{"row":10,"column":119},"action":"insert","lines":["t"],"id":77}],[{"start":{"row":10,"column":119},"end":{"row":10,"column":120},"action":"insert","lines":["e"],"id":78}],[{"start":{"row":10,"column":120},"end":{"row":10,"column":121},"action":"insert","lines":["x"],"id":79}],[{"start":{"row":10,"column":121},"end":{"row":10,"column":122},"action":"insert","lines":["t"],"id":80}],[{"start":{"row":0,"column":0},"end":{"row":22,"column":7},"action":"remove","lines":["{% extends \"layout.html\" %}","","{% block title %}","    Register","{% endblock %}","","{% block main %}","    <form action=\"{{ url_for('register') }}\" method=\"post\">","        <fieldset>","            <div class=\"form-group\">","                <input autocomplete=\"off\" autofocus class=\"form-control\" name=\"username\" placeholder=\"username\" type=\"text\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"password\" placeholder=\"Password\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"confirmation\" placeholder=\"Password (again)\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <button class=\"btn btn-default\" type=\"submit\">Register</button>","            </div>","        </fieldset>","</form>"],"id":81},{"start":{"row":0,"column":0},"end":{"row":326,"column":35},"action":"insert","lines":["from cs50 import SQL","from flask import Flask, flash, redirect, render_template, request, session, url_for","from flask_session import Session","from passlib.apps import custom_app_context as pwd_context","from tempfile import gettempdir","","from helpers import *","","# configure application","app = Flask(__name__)","","# ensure responses aren't cached","if app.config[\"DEBUG\"]:","    @app.after_request","    def after_request(response):","        response.headers[\"Cache-Control\"] = \"no-cache, no-store, must-revalidate\"","        response.headers[\"Expires\"] = 0","        response.headers[\"Pragma\"] = \"no-cache\"","        return response","","# custom filter","app.jinja_env.filters[\"usd\"] = usd","","# configure session to use filesystem (instead of signed cookies)","app.config[\"SESSION_FILE_DIR\"] = gettempdir()","app.config[\"SESSION_PERMANENT\"] = False","app.config[\"SESSION_TYPE\"] = \"filesystem\"","Session(app)","","# configure CS50 Library to use SQLite database","db = SQL(\"sqlite:///finance.db\")","","@app.route(\"/\")","@login_required","def index():","    # select each symbol owned by the user and it's amount","    portfolio_symbols = db.execute(\"SELECT shares, symbol \\","                                    FROM portfolio WHERE id = :id\", \\","                                    id=session[\"user_id\"])","    ","    # create a temporary variable to store TOTAL worth ( cash + share)","    total_cash = 0","    ","    # update each symbol prices and total","    for portfolio_symbol in portfolio_symbols:","        symbol = portfolio_symbol[\"symbol\"]","        shares = portfolio_symbol[\"shares\"]","        stock = lookup(symbol)","        total = shares * stock[\"price\"]","        total_cash += total","        db.execute(\"UPDATE portfolio SET price=:price, \\","                    total=:total WHERE id=:id AND symbol=:symbol\", \\","                    price=usd(stock[\"price\"]), \\","                    total=usd(total), id=session[\"user_id\"], symbol=symbol)","    ","    # update user's cash in portfolio","    updated_cash = db.execute(\"SELECT cash FROM users \\","                               WHERE id=:id\", id=session[\"user_id\"])","    ","    # update total cash -> cash + shares worth","    total_cash += updated_cash[0][\"cash\"]","    ","    # print portfolio in index homepage","    updated_portfolio = db.execute(\"SELECT * from portfolio \\","                                    WHERE id=:id\", id=session[\"user_id\"])","                                    ","    return render_template(\"index.html\", stocks=updated_portfolio, \\","                            cash=usd(updated_cash[0][\"cash\"]), total= usd(total_cash) )","","@app.route(\"/buy\", methods=[\"GET\", \"POST\"])","@login_required","def buy():","    \"\"\"Buy shares of stock.\"\"\"","    ","    if request.method == \"GET\":","        return render_template(\"buy.html\")","    else:","        # ensure proper symbol","        stock = lookup(request.form.get(\"symbol\"))","        if not stock:","            return apology(\"Invalid Symbol\")","        ","        # ensure proper number of shares","        try:","            shares = int(request.form.get(\"shares\"))","            if shares < 0:","                return apology(\"Shares must be positive integer\")","        except:","            return apology(\"Shares must be positive integer\")","        ","        # select user's cash","        money = db.execute(\"SELECT cash FROM users WHERE id = :id\", \\","                            id=session[\"user_id\"])","        ","        # check if enough money to buy","        if not money or float(money[0][\"cash\"]) < stock[\"price\"] * shares:","            return apology(\"Not enough money\")","        ","        # update history","        db.execute(\"INSERT INTO histories (symbol, shares, price, id) \\","                    VALUES(:symbol, :shares, :price, :id)\", \\","                    symbol=stock[\"symbol\"], shares=shares, \\","                    price=usd(stock[\"price\"]), id=session[\"user_id\"])","                       ","        # update user cash               ","        db.execute(\"UPDATE users SET cash = cash - :purchase WHERE id = :id\", \\","                    id=session[\"user_id\"], \\","                    purchase=stock[\"price\"] * float(shares))","                        ","        # Select user shares of that symbol","        user_shares = db.execute(\"SELECT shares FROM portfolio \\","                           WHERE id = :id AND symbol=:symbol\", \\","                           id=session[\"user_id\"], symbol=stock[\"symbol\"])","                           ","        # if user doesn't has shares of that symbol, create new stock object","        if not user_shares:","            db.execute(\"INSERT INTO portfolio (name, shares, price, total, symbol, id) \\","                        VALUES(:name, :shares, :price, :total, :symbol, :id)\", \\","                        name=stock[\"name\"], shares=shares, price=usd(stock[\"price\"]), \\","                        total=usd(shares * stock[\"price\"]), \\","                        symbol=stock[\"symbol\"], id=session[\"user_id\"])","                        ","        # Else increment the shares count","        else:","            shares_total = user_shares[0][\"shares\"] + shares","            db.execute(\"UPDATE portfolio SET shares=:shares \\","                        WHERE id=:id AND symbol=:symbol\", \\","                        shares=shares_total, id=session[\"user_id\"], \\","                        symbol=stock[\"symbol\"])","        ","        # return to index","        return redirect(url_for(\"index\"))","        ","","@app.route(\"/history\")","@login_required","def history():","    \"\"\"Show history of transactions.\"\"\"","    histories = db.execute(\"SELECT * from histories WHERE id=:id\", id=session[\"user_id\"])","    ","    return render_template(\"history.html\", histories=histories)","","@app.route(\"/login\", methods=[\"GET\", \"POST\"])","def login():","    \"\"\"Log user in.\"\"\"","","    # forget any user_id","    session.clear()","","    # if user reached route via POST (as by submitting a form via POST)","    if request.method == \"POST\":","","        # ensure username was submitted","        if not request.form.get(\"username\"):","            return apology(\"Must provide username\")","","        # ensure password was submitted","        elif not request.form.get(\"password\"):","            return apology(\"Must provide password\")","","        # query database for username","        rows = db.execute(\"SELECT * FROM users \\","                           WHERE username = :username\", \\","                           username=request.form.get(\"username\"))","","        # ensure username exists and password is correct","        if len(rows) != 1 or not pwd_context.verify(request.form.get(\"password\"), rows[0][\"hash\"]):","            return apology(\"invalid username and/or password\")","","        # remember which user has logged in","        session[\"user_id\"] = rows[0][\"id\"]","","        # redirect user to home page","        return redirect(url_for(\"index\"))","","    # else if user reached route via GET (as by clicking a link or via redirect)","    else:","        return render_template(\"login.html\")","","@app.route(\"/logout\")","def logout():","    \"\"\"Log user out.\"\"\"","","    # forget any user_id","    session.clear()","","    # redirect user to login form","    return redirect(url_for(\"login\"))","","@app.route(\"/quote\", methods=[\"GET\", \"POST\"])","@login_required","def quote():","    \"\"\"Get stock quote.\"\"\"","    ","    if request.method == \"POST\":","        rows = lookup(request.form.get(\"symbol\"))","        ","        if not rows:","            return apology(\"Invalid Symbol\")","            ","        return render_template(\"quoted.html\", stock=rows)","    ","    else:","        return render_template(\"quote.html\")","    ","","@app.route(\"/register\", methods=[\"GET\", \"POST\"])","def register():","    \"\"\"Register user.\"\"\"","    ","    if request.method == \"POST\":","        ","        # ensure username was submitted","        if not request.form.get(\"username\"):","            return apology(\"Must provide username\")","            ","        # ensure password was submitted    ","        elif not request.form.get(\"password\"):","            return apology(\"Must provide password\")","        ","        # ensure password and verified password is the same","        elif request.form.get(\"password\") != request.form.get(\"passwordagain\"):","            return apology(\"password doesn't match\")","        ","        # insert the new user into users, storing the hash of the user's password","        result = db.execute(\"INSERT INTO users (username, hash) \\","                             VALUES(:username, :hash)\", \\","                             username=request.form.get(\"username\"), \\","                             hash=pwd_context.encrypt(request.form.get(\"password\")))","                 ","        if not result:","            return apology(\"Username already exist\")","        ","        # remember which user has logged in","        session[\"user_id\"] = result","","        # redirect user to home page","        return redirect(url_for(\"index\"))","    ","    else:","        return render_template(\"register.html\")                ","","@app.route(\"/sell\", methods=[\"GET\", \"POST\"])","@login_required","def sell():","    \"\"\"Sell shares of stock.\"\"\"","    if request.method == \"GET\":","        return render_template(\"sell.html\")","    else:","        # ensure proper symbol","        stock = lookup(request.form.get(\"symbol\"))","        if not stock:","            return apology(\"Invalid Symbol\")","        ","        # ensure proper number of shares","        try:","            shares = int(request.form.get(\"shares\"))","            if shares < 0:","                return apology(\"Shares must be positive integer\")","        except:","            return apology(\"Shares must be positive integer\")","        ","        # select the symbol shares of that user","        user_shares = db.execute(\"SELECT shares FROM portfolio \\","                                 WHERE id = :id AND symbol=:symbol\", \\","                                 id=session[\"user_id\"], symbol=stock[\"symbol\"])","        ","        # check if enough shares to sell","        if not user_shares or int(user_shares[0][\"shares\"]) < shares:","            return apology(\"Not enough shares\")","        ","        # update history of a sell","        db.execute(\"INSERT INTO histories (symbol, shares, price, id) \\","                    VALUES(:symbol, :shares, :price, :id)\", \\","                    symbol=stock[\"symbol\"], shares=-shares, \\","                    price=usd(stock[\"price\"]), id=session[\"user_id\"])","                       ","        # update user cash (increase)              ","        db.execute(\"UPDATE users SET cash = cash + :purchase WHERE id = :id\", \\","                    id=session[\"user_id\"], \\","                    purchase=stock[\"price\"] * float(shares))","                        ","        # decrement the shares count","        shares_total = user_shares[0][\"shares\"] - shares","        ","        # if after decrement is zero, delete shares from portfolio","        if shares_total == 0:","            db.execute(\"DELETE FROM portfolio \\","                        WHERE id=:id AND symbol=:symbol\", \\","                        id=session[\"user_id\"], \\","                        symbol=stock[\"symbol\"])","        # otherwise, update portfolio shares count","        else:","            db.execute(\"UPDATE portfolio SET shares=:shares \\","                    WHERE id=:id AND symbol=:symbol\", \\","                    shares=shares_total, id=session[\"user_id\"], \\","                    symbol=stock[\"symbol\"])","        ","        # return to index","        return redirect(url_for(\"index\"))","        ","@app.route(\"/loan\", methods=[\"GET\", \"POST\"])","@login_required","def loan():","    \"\"\"Get a loan.\"\"\"","    ","    if request.method == \"POST\":","        ","        # ensure must be integers","        try:","            loan = int(request.form.get(\"loan\"))","            if loan < 0:","                return apology(\"Loan must be positive amount\")","            elif loan > 1000:","                return apology(\"Cannot loan more than $1,000 at once\")","        except:","            return apology(\"Loan must be positive integer\")","            ","        # update user cash (increase)              ","        db.execute(\"UPDATE users SET cash = cash + :loan WHERE id = :id\", \\","                    loan=loan, id=session[\"user_id\"])","        ","        # return to index","        return apology(\"Loan is successful\", \"No need to pay me back\")","    ","    else:","return render_template(\"loan.html\")"]}],[{"start":{"row":0,"column":0},"end":{"row":326,"column":35},"action":"remove","lines":["from cs50 import SQL","from flask import Flask, flash, redirect, render_template, request, session, url_for","from flask_session import Session","from passlib.apps import custom_app_context as pwd_context","from tempfile import gettempdir","","from helpers import *","","# configure application","app = Flask(__name__)","","# ensure responses aren't cached","if app.config[\"DEBUG\"]:","    @app.after_request","    def after_request(response):","        response.headers[\"Cache-Control\"] = \"no-cache, no-store, must-revalidate\"","        response.headers[\"Expires\"] = 0","        response.headers[\"Pragma\"] = \"no-cache\"","        return response","","# custom filter","app.jinja_env.filters[\"usd\"] = usd","","# configure session to use filesystem (instead of signed cookies)","app.config[\"SESSION_FILE_DIR\"] = gettempdir()","app.config[\"SESSION_PERMANENT\"] = False","app.config[\"SESSION_TYPE\"] = \"filesystem\"","Session(app)","","# configure CS50 Library to use SQLite database","db = SQL(\"sqlite:///finance.db\")","","@app.route(\"/\")","@login_required","def index():","    # select each symbol owned by the user and it's amount","    portfolio_symbols = db.execute(\"SELECT shares, symbol \\","                                    FROM portfolio WHERE id = :id\", \\","                                    id=session[\"user_id\"])","    ","    # create a temporary variable to store TOTAL worth ( cash + share)","    total_cash = 0","    ","    # update each symbol prices and total","    for portfolio_symbol in portfolio_symbols:","        symbol = portfolio_symbol[\"symbol\"]","        shares = portfolio_symbol[\"shares\"]","        stock = lookup(symbol)","        total = shares * stock[\"price\"]","        total_cash += total","        db.execute(\"UPDATE portfolio SET price=:price, \\","                    total=:total WHERE id=:id AND symbol=:symbol\", \\","                    price=usd(stock[\"price\"]), \\","                    total=usd(total), id=session[\"user_id\"], symbol=symbol)","    ","    # update user's cash in portfolio","    updated_cash = db.execute(\"SELECT cash FROM users \\","                               WHERE id=:id\", id=session[\"user_id\"])","    ","    # update total cash -> cash + shares worth","    total_cash += updated_cash[0][\"cash\"]","    ","    # print portfolio in index homepage","    updated_portfolio = db.execute(\"SELECT * from portfolio \\","                                    WHERE id=:id\", id=session[\"user_id\"])","                                    ","    return render_template(\"index.html\", stocks=updated_portfolio, \\","                            cash=usd(updated_cash[0][\"cash\"]), total= usd(total_cash) )","","@app.route(\"/buy\", methods=[\"GET\", \"POST\"])","@login_required","def buy():","    \"\"\"Buy shares of stock.\"\"\"","    ","    if request.method == \"GET\":","        return render_template(\"buy.html\")","    else:","        # ensure proper symbol","        stock = lookup(request.form.get(\"symbol\"))","        if not stock:","            return apology(\"Invalid Symbol\")","        ","        # ensure proper number of shares","        try:","            shares = int(request.form.get(\"shares\"))","            if shares < 0:","                return apology(\"Shares must be positive integer\")","        except:","            return apology(\"Shares must be positive integer\")","        ","        # select user's cash","        money = db.execute(\"SELECT cash FROM users WHERE id = :id\", \\","                            id=session[\"user_id\"])","        ","        # check if enough money to buy","        if not money or float(money[0][\"cash\"]) < stock[\"price\"] * shares:","            return apology(\"Not enough money\")","        ","        # update history","        db.execute(\"INSERT INTO histories (symbol, shares, price, id) \\","                    VALUES(:symbol, :shares, :price, :id)\", \\","                    symbol=stock[\"symbol\"], shares=shares, \\","                    price=usd(stock[\"price\"]), id=session[\"user_id\"])","                       ","        # update user cash               ","        db.execute(\"UPDATE users SET cash = cash - :purchase WHERE id = :id\", \\","                    id=session[\"user_id\"], \\","                    purchase=stock[\"price\"] * float(shares))","                        ","        # Select user shares of that symbol","        user_shares = db.execute(\"SELECT shares FROM portfolio \\","                           WHERE id = :id AND symbol=:symbol\", \\","                           id=session[\"user_id\"], symbol=stock[\"symbol\"])","                           ","        # if user doesn't has shares of that symbol, create new stock object","        if not user_shares:","            db.execute(\"INSERT INTO portfolio (name, shares, price, total, symbol, id) \\","                        VALUES(:name, :shares, :price, :total, :symbol, :id)\", \\","                        name=stock[\"name\"], shares=shares, price=usd(stock[\"price\"]), \\","                        total=usd(shares * stock[\"price\"]), \\","                        symbol=stock[\"symbol\"], id=session[\"user_id\"])","                        ","        # Else increment the shares count","        else:","            shares_total = user_shares[0][\"shares\"] + shares","            db.execute(\"UPDATE portfolio SET shares=:shares \\","                        WHERE id=:id AND symbol=:symbol\", \\","                        shares=shares_total, id=session[\"user_id\"], \\","                        symbol=stock[\"symbol\"])","        ","        # return to index","        return redirect(url_for(\"index\"))","        ","","@app.route(\"/history\")","@login_required","def history():","    \"\"\"Show history of transactions.\"\"\"","    histories = db.execute(\"SELECT * from histories WHERE id=:id\", id=session[\"user_id\"])","    ","    return render_template(\"history.html\", histories=histories)","","@app.route(\"/login\", methods=[\"GET\", \"POST\"])","def login():","    \"\"\"Log user in.\"\"\"","","    # forget any user_id","    session.clear()","","    # if user reached route via POST (as by submitting a form via POST)","    if request.method == \"POST\":","","        # ensure username was submitted","        if not request.form.get(\"username\"):","            return apology(\"Must provide username\")","","        # ensure password was submitted","        elif not request.form.get(\"password\"):","            return apology(\"Must provide password\")","","        # query database for username","        rows = db.execute(\"SELECT * FROM users \\","                           WHERE username = :username\", \\","                           username=request.form.get(\"username\"))","","        # ensure username exists and password is correct","        if len(rows) != 1 or not pwd_context.verify(request.form.get(\"password\"), rows[0][\"hash\"]):","            return apology(\"invalid username and/or password\")","","        # remember which user has logged in","        session[\"user_id\"] = rows[0][\"id\"]","","        # redirect user to home page","        return redirect(url_for(\"index\"))","","    # else if user reached route via GET (as by clicking a link or via redirect)","    else:","        return render_template(\"login.html\")","","@app.route(\"/logout\")","def logout():","    \"\"\"Log user out.\"\"\"","","    # forget any user_id","    session.clear()","","    # redirect user to login form","    return redirect(url_for(\"login\"))","","@app.route(\"/quote\", methods=[\"GET\", \"POST\"])","@login_required","def quote():","    \"\"\"Get stock quote.\"\"\"","    ","    if request.method == \"POST\":","        rows = lookup(request.form.get(\"symbol\"))","        ","        if not rows:","            return apology(\"Invalid Symbol\")","            ","        return render_template(\"quoted.html\", stock=rows)","    ","    else:","        return render_template(\"quote.html\")","    ","","@app.route(\"/register\", methods=[\"GET\", \"POST\"])","def register():","    \"\"\"Register user.\"\"\"","    ","    if request.method == \"POST\":","        ","        # ensure username was submitted","        if not request.form.get(\"username\"):","            return apology(\"Must provide username\")","            ","        # ensure password was submitted    ","        elif not request.form.get(\"password\"):","            return apology(\"Must provide password\")","        ","        # ensure password and verified password is the same","        elif request.form.get(\"password\") != request.form.get(\"passwordagain\"):","            return apology(\"password doesn't match\")","        ","        # insert the new user into users, storing the hash of the user's password","        result = db.execute(\"INSERT INTO users (username, hash) \\","                             VALUES(:username, :hash)\", \\","                             username=request.form.get(\"username\"), \\","                             hash=pwd_context.encrypt(request.form.get(\"password\")))","                 ","        if not result:","            return apology(\"Username already exist\")","        ","        # remember which user has logged in","        session[\"user_id\"] = result","","        # redirect user to home page","        return redirect(url_for(\"index\"))","    ","    else:","        return render_template(\"register.html\")                ","","@app.route(\"/sell\", methods=[\"GET\", \"POST\"])","@login_required","def sell():","    \"\"\"Sell shares of stock.\"\"\"","    if request.method == \"GET\":","        return render_template(\"sell.html\")","    else:","        # ensure proper symbol","        stock = lookup(request.form.get(\"symbol\"))","        if not stock:","            return apology(\"Invalid Symbol\")","        ","        # ensure proper number of shares","        try:","            shares = int(request.form.get(\"shares\"))","            if shares < 0:","                return apology(\"Shares must be positive integer\")","        except:","            return apology(\"Shares must be positive integer\")","        ","        # select the symbol shares of that user","        user_shares = db.execute(\"SELECT shares FROM portfolio \\","                                 WHERE id = :id AND symbol=:symbol\", \\","                                 id=session[\"user_id\"], symbol=stock[\"symbol\"])","        ","        # check if enough shares to sell","        if not user_shares or int(user_shares[0][\"shares\"]) < shares:","            return apology(\"Not enough shares\")","        ","        # update history of a sell","        db.execute(\"INSERT INTO histories (symbol, shares, price, id) \\","                    VALUES(:symbol, :shares, :price, :id)\", \\","                    symbol=stock[\"symbol\"], shares=-shares, \\","                    price=usd(stock[\"price\"]), id=session[\"user_id\"])","                       ","        # update user cash (increase)              ","        db.execute(\"UPDATE users SET cash = cash + :purchase WHERE id = :id\", \\","                    id=session[\"user_id\"], \\","                    purchase=stock[\"price\"] * float(shares))","                        ","        # decrement the shares count","        shares_total = user_shares[0][\"shares\"] - shares","        ","        # if after decrement is zero, delete shares from portfolio","        if shares_total == 0:","            db.execute(\"DELETE FROM portfolio \\","                        WHERE id=:id AND symbol=:symbol\", \\","                        id=session[\"user_id\"], \\","                        symbol=stock[\"symbol\"])","        # otherwise, update portfolio shares count","        else:","            db.execute(\"UPDATE portfolio SET shares=:shares \\","                    WHERE id=:id AND symbol=:symbol\", \\","                    shares=shares_total, id=session[\"user_id\"], \\","                    symbol=stock[\"symbol\"])","        ","        # return to index","        return redirect(url_for(\"index\"))","        ","@app.route(\"/loan\", methods=[\"GET\", \"POST\"])","@login_required","def loan():","    \"\"\"Get a loan.\"\"\"","    ","    if request.method == \"POST\":","        ","        # ensure must be integers","        try:","            loan = int(request.form.get(\"loan\"))","            if loan < 0:","                return apology(\"Loan must be positive amount\")","            elif loan > 1000:","                return apology(\"Cannot loan more than $1,000 at once\")","        except:","            return apology(\"Loan must be positive integer\")","            ","        # update user cash (increase)              ","        db.execute(\"UPDATE users SET cash = cash + :loan WHERE id = :id\", \\","                    loan=loan, id=session[\"user_id\"])","        ","        # return to index","        return apology(\"Loan is successful\", \"No need to pay me back\")","    ","    else:","return render_template(\"loan.html\")"],"id":82},{"start":{"row":0,"column":0},"end":{"row":23,"column":14},"action":"insert","lines":["{% extends \"layout.html\" %}","","{% block title %}","    Register","{% endblock %}","","{% block main %}","    <form action=\"{{ url_for('register') }}\" method=\"post\">","        <fieldset>","            <div class=\"form-group\">","                <input autocomplete=\"off\" autofocus class=\"form-control\" name=\"username\" placeholder=\"Username\" type=\"text\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"password\" placeholder=\"Password\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <input class=\"form-control\" name=\"passwordagain\" placeholder=\"Password (again)\" type=\"password\"/>","            </div>","            <div class=\"form-group\">","                <button class=\"btn btn-default\" type=\"submit\">Register</button>","            </div>","        </fieldset>","    </form>","{% endblock %}"]}],[{"start":{"row":16,"column":63},"end":{"row":16,"column":64},"action":"insert","lines":["\\"],"id":83}],[{"start":{"row":16,"column":64},"end":{"row":16,"column":65},"action":"insert","lines":["\\"],"id":84}],[{"start":{"row":16,"column":65},"end":{"row":16,"column":66},"action":"insert","lines":["\\"],"id":85}],[{"start":{"row":16,"column":65},"end":{"row":16,"column":66},"action":"remove","lines":["\\"],"id":86}],[{"start":{"row":16,"column":64},"end":{"row":16,"column":65},"action":"remove","lines":["\\"],"id":87}],[{"start":{"row":16,"column":63},"end":{"row":16,"column":64},"action":"remove","lines":["\\"],"id":88}],[{"start":{"row":16,"column":62},"end":{"row":16,"column":63},"action":"remove","lines":["n"],"id":89}],[{"start":{"row":16,"column":61},"end":{"row":16,"column":62},"action":"remove","lines":["i"],"id":90}],[{"start":{"row":16,"column":60},"end":{"row":16,"column":61},"action":"remove","lines":["a"],"id":91}],[{"start":{"row":16,"column":59},"end":{"row":16,"column":60},"action":"remove","lines":["g"],"id":92}],[{"start":{"row":16,"column":58},"end":{"row":16,"column":59},"action":"remove","lines":["a"],"id":93}],[{"start":{"row":16,"column":57},"end":{"row":16,"column":58},"action":"remove","lines":["d"],"id":94}],[{"start":{"row":16,"column":56},"end":{"row":16,"column":57},"action":"remove","lines":["r"],"id":95}],[{"start":{"row":16,"column":55},"end":{"row":16,"column":56},"action":"remove","lines":["o"],"id":96}],[{"start":{"row":16,"column":54},"end":{"row":16,"column":55},"action":"remove","lines":["w"],"id":97}],[{"start":{"row":16,"column":53},"end":{"row":16,"column":54},"action":"remove","lines":["s"],"id":98}],[{"start":{"row":16,"column":52},"end":{"row":16,"column":53},"action":"remove","lines":["s"],"id":99}],[{"start":{"row":16,"column":51},"end":{"row":16,"column":52},"action":"remove","lines":["a"],"id":100}],[{"start":{"row":16,"column":50},"end":{"row":16,"column":51},"action":"remove","lines":["p"],"id":101}],[{"start":{"row":16,"column":50},"end":{"row":16,"column":51},"action":"insert","lines":["c"],"id":102}],[{"start":{"row":16,"column":51},"end":{"row":16,"column":52},"action":"insert","lines":["o"],"id":103}],[{"start":{"row":16,"column":52},"end":{"row":16,"column":53},"action":"insert","lines":["n"],"id":104}],[{"start":{"row":16,"column":53},"end":{"row":16,"column":54},"action":"insert","lines":["f"],"id":105}],[{"start":{"row":16,"column":54},"end":{"row":16,"column":55},"action":"insert","lines":["i"],"id":106}],[{"start":{"row":16,"column":55},"end":{"row":16,"column":56},"action":"insert","lines":["r"],"id":107}],[{"start":{"row":16,"column":56},"end":{"row":16,"column":57},"action":"insert","lines":["m"],"id":108}],[{"start":{"row":16,"column":57},"end":{"row":16,"column":58},"action":"insert","lines":["a"],"id":109}],[{"start":{"row":16,"column":58},"end":{"row":16,"column":59},"action":"insert","lines":["t"],"id":110}],[{"start":{"row":16,"column":59},"end":{"row":16,"column":60},"action":"insert","lines":["i"],"id":111}],[{"start":{"row":16,"column":60},"end":{"row":16,"column":61},"action":"insert","lines":["o"],"id":112}],[{"start":{"row":16,"column":61},"end":{"row":16,"column":62},"action":"insert","lines":["n"],"id":113}]]},"timestamp":1528903910529}